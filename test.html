<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <style>
            span[data-seismic-variable] {
                background:#ccc;
            }
            div{

                overflow: scroll;
                resize: both;
            }
        </style>
    </head>
    <body class="demo-namespace">
        <div id="main" style="height:300px" contenteditable="true">
          123123 <span data-seismic-variable>variable</span> asdasdasd
        </div>
        <script>
const DocumentPosition = {
    /**
     * Same node
     */
    Same: 0,

    /**
     * Node is disconnected from document
     */
    Disconnected: 1,

    /**
     * Node is preceding the comparing node
     */
    Preceding: 2,

    /**
     * Node is following the comparing node
     */
    Following: 4,

    /**
     * Node contains the comparing node
     */
    Contains: 8,

    /**
     * Node is contained by the comparing node
     */
    ContainedBy: 16
}


    function getVariable(node) {
        if (node === document.getElementById('main')) return;
        if (node.hasAttribute && node.hasAttribute('data-seismic-variable')) return node;

        if (node.parentElement)
            return getVariable(node.parentElement)
    }

        document.addEventListener('selectionchange', event => {

            const selection = document.getSelection();
            //  console.error('selection', selection);
            if (selection?.isCollapsed) return;

            // console.error('selectionchange',selection);
            // const range = editor.getSelectionRange();
            const start = getVariable(selection.anchorNode);
            const end = getVariable(selection.focusNode);
            if (!(start || end)) return;
            const order = selection.anchorNode.compareDocumentPosition(selection.focusNode);
            console.error('order', order);
            if (start === end) {
                // <---
                console.error(selection.anchorOffset , selection.focusOffset);
                if (selection.anchorOffset > selection.focusOffset) {
                    selection.setBaseAndExtent(end, 1, start, 0)
                } else {
                // --->
                    selection.setBaseAndExtent(start, 0, end, 1)
                }
            } else if (end) {
                if (order === DocumentPosition.Preceding) {
                    selection.extend(end,0)
                }

                if (order === DocumentPosition.Following) {
                    selection.extend(end,1);
                }
            }
            // if (start) {
            //     if (order === )
            // }
            console.error(start, end, selection.anchorNode.compareDocumentPosition(selection.focusNode))


                // console.error('comparePoint', range.comparePoint(start || end, offset))

            // if (start && range.startOffset !== 0) {
            //     // range.setStart(start, 0);
            //     selection?.setBaseAndExtent(start, 0, start, 0);
            //     // selection?.setPosition(start, 0);
            // }

            // if (end && end.endOffset !== end.innerText.length) {

            //     range.setEnd(end, end.innerText.length);
            // }
        });
            // setTimeout(() => {
            //         // window.getSelection().modify('extend', 'forward', 'word');
            //         window.getSelection().extend(document.querySelector('span[data-seismic-variable]'), 0);
            // }, 5000)
        </script>
    </body>
</html>
